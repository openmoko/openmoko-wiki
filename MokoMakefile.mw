

==MokoMakefile==
MokoMakefile is a fully automated way of setting up an OpenMoko development environment.  It is an invaluable tool for getting new developers up and running with a build environment which is configured the same as all the other existing developers.  It brings the same repeatability to build environment creation and maintenance as that which OpenEmbedded brings to the main task of actually building embedded software distributions.

Note that MokoMakefile does *not* replace bitbake, or svn, or monotone, or openembedded, or qmake, or anything else.  It is a wrapper around all that to make it easy to set up and maintain a development environment that fully complies with the setup instructions published by OpenMoko.  Note that you need about 7 GB of available disk space for MokoMakefile to succeed.

MokoMakefile is developed by [[User:RodWhitby|Rod Whitby]] - it is not an official product of OpenMoko (although I would be happy for them to pick it up and use it internally).  If there is any discrepancy between the [[Building_OpenMoko_from_scratch|official OpenMoko build instructions]], and the operation of the MokoMakefile, then you should consider the official instructions to be correct.

=== Installation ===
Here are the steps to use it:

1 - Make sure your build host is set up according to:
   http://www.openembedded.org/wiki/OEandYourDistro
2 - Create your $OMDIR directory:
   mkdir /home/moko ; cd /home/moko
3 - Grab MokoMakefile:
   wget http://www.rwhitby.net/files/openmoko/Makefile
4 - Set up the environment:
   make setup
5 - Start building:
   make openmoko-devel-image

This will set up the recommended directory structure as described in [[Building OpenMoko from scratch]], will download all the required software (from the right places with the right versions), and will immediately start building an image.

Once you have done this, you can choose to continue using the MokoMakefile to initiate your subsequent builds, or you can go into the build directory and run bitbake commands manually.  The choice is yours.

===Updating the environment=== 
For easy maintenance of your build environment the following commands are available.

1 - To update the MokoMakefile to the latest version:
   make update-makefile 

2 - To update the OpenMoko repository checkout and the MokoMakefile patches to the latest version:
   make update

3 - To make sure that any recent changes to the build directory structure have been applied:
   make setup 

A quick way to rebuild a new image with the latest updates:
   make update-makefile; make update; make setup; make openmoko-devel-image

===Reporting Problems===

First, make sure that the problem is reproducable after running

 make update-makefile ; make update ; make setup

then running

 make clean-package-<foo>

(where you replace <foo> with the name of the package which is failing)

then running

 make all

If you can get the error to occur three times in a row after running that sequence of commands three times, then feel free to report it to rwhitby in #openmoko on [http://wiki.openmoko.org/wiki/Development_resources#IRC IRC].

===Work-arounds===

Work-arounds for temporary or isolated problems should be added to the [[Talk:MokoMakefile|Discussion page]] which is associated with this page.  As they are fixed, they will be removed from that page.

===Tips=== 
*You can reduce the amount of consumed disk space significantly by adding
   INHERIT += "rm_work"
in your local.conf (e.g. /home/moko/build/conf/local.conf). This will remove the contents of each build/tmp/work/*/<package> directory after the corresponding package builds correctly.


*If you an encounter an error with monotone similar to the following:
   mtn: misuse: database /home/moko/OE.mtn is laid out according to an old schema
Then you need to upgrade OE.mtn  Use the following command while in /home/moko:
   # mtn --db OE.mtn db migrate

*If a certain package does not build due to corrupted download or some such try to remove the sources and rebuild it.
 rm sources/<package>*
 cd build
 . ../setup-env
 bitbake -crebuild <package>
after that your build might just work again.

*For people with multiple CPU's (or dual-core ones) this small patch might be useful to build things faster.
Edit the local.conf and add the following lines:
 PARALLEL_MAKE = "-j 4"
 BB_NUMBER_THREADS = "4"

Change the PARALLEL_MAKE and BB_NUMBER_THREADS values to something that suits better if it chokes your machine.

*For amd64 host users you need the patch from http://bugs.openembedded.org/show_bug.cgi?id=1765 to build db3-native



===Testimonials=== 
MokoMakefile is recommended by 4 out of 4 new developers on #openmoko, with testimonials such as "For some reason last night I couldn't get my manual install of everything to work (bb complained about my bbpath I think) ... but with your makefile, it works great!", and "MokoMakefile rocks!".

Project page:
http://mokomakefile.projects.openmoko.org/

{{Languages|MokoMakefile}}
