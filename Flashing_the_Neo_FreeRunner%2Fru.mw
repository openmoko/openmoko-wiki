{{Languages|Flashing_the_Neo_FreeRunner}}
Openmoko регулярно выпускает обновлённые версии Openmoko корневой файловой системы, [[kernel]], и [[Bootloader/ru| U-Boot]] в двоичных образах. Всё это может быть записано во Flash память(NAND) Neo FreeRunner. Для этого, вы можете использовать USB кабель и другой компьютер чтобы прошить Neo FreeRunner "через" USB.

== Обзор ==
Все компоненты программного обеспечения FreeRunner объединяются в месте в двоичные образы.

В настольном компьютере когда Вы хотите заменить операционную систему (OS), вы должны загрузиться с привода CD-ROM, затем скопировать файлы OS с CD на жесткий диск. FreeRunner не имеет привода CD-ROM и файлы должны быть перезаписаны/прошиты непосредственно на внутренний накопитель (NAND flash). Так же возможно записать все файлы OS на внешнюю карту памяти microSD и загружаться с неё.


FreeRunner имеет два внутренних накопителя: NOR flash и NAND flash. NOR flash небольшая и хранит только специальную загрузочную программу, используемую когда вам нужно перезаписать или прочитать содержимое на NAND flash. NAND flash работает как накопитель, типа жесткого диска.

The NAND Flash разбит на три раздела, для загрузчика (bootloader), ядра (kernel) и корневой файловой системы (root filesystem) - все эти компоненты могут быть перезаписаны по отдельности. Например если вы хотите установить модифицированное ядро, вам нужно сделать только один шаг, прошить образ ядра.
* '''загрузчик (bootloader)''': это небольшая программа которая загружается первой и запускается при включении или reset FreeRunner(в зависимости [[Booting the Neo FreeRunner/ru|какую загрузку выбрали]], версию для NOR или NAND загрузчика).
* '''ядро (kernel)''': Основной компонент операционной системы Linux.
* '''корневая ФС (root filesystem)''': содержит все файлы, образующие команды и приложения, которые вы можете запустить.

'''Прежде чем начинать: Очистка root filesystem или прошивка uboot это радикальные меры. Подумайте о необходимости таких действий. Иногда проблемы могут быть устранены обновлением только ядра.'''

== Альтернатива : запуск с карточки microSD ==

Вы можете установить дистрибутив на карте microSD, для того, чтобы  [[Booting from SD/ru | загружаться с microSD карты]]. Это позволит вам, сохранить другой дистрибутив установленный в NAND (например, чтобы тестировать 2008.08 и иметь 2007.2 для загрузки по умолчанию).

== Соберите то что вам нужно ==

=== Скачивание программы DFU-util ===

Установите эту программу на ваш компьютер. Это позволит вам подключать FreeRunner по кабелю USB и управлять загрузчиком. Это соединение использует специальный протокол который обращается к интерфейсу загрузчика и отличается от связи(организации сети) по USB. Есть отдельная страница с более подробным описанием: [[dfu-util]].


'''MacOS X:''' [[MacOS_X#Graphical_Flashing_with_Openmoko_Flasher]]

'''Linux:''' http://downloads.openmoko.org/releases/Om2008.8-update/dfu-util

Убедитесь, что dfu-util имеет права на выполнение, установите их командой: chmod a+x dfu-util

'''Важно:''' Кажется, на 64-bit версии Linux утилита dfu-util падает с ошибкой "-62". Если у вас в распоряжении есть 32-bit машина, лучше используйте ее!
Есть некоторые пакеты в ubuntu64 interpid, которые работают хорошо также и в hardy. Поэтому можете попробовать на свой собственный риск: [http://packages.ubuntu.com/de/intrepid/dfu-util].

Использование 32-bit chroot (на amd64 debian) у меня работало --[[User:Bubak|Bubak]] 16:54, 4 September 2008 (UTC).

'''Windows:''' http://projects.openmoko.org/frs/?group_id=166&release_id=162

Смотрите дополнительные инструкции по установке драйверов для Windows в [[Dfu-util-windows]]

=== Скачивание образа который вам нужен ===

То, какие точно файлы вам нужны, зависит от того, что вы пытаетесь установить. В большинстве случаев вам потребуется установить ядро (uImage) и корневую файловую систему (rootfs). В редких случаях, когда вы хотите исправить некоторые ошибки, вам потребуется также установить новый загрузчик.

Пожалуйста, прочтите страницу [[Distributions | Дистрибутивы]] для выбора дистрибутива, который соответствует вашим потребностям, затем обратитесь к странице [[Download | Загрузка]] для загрузки.

== Загрузка FreeRunner с NOR Flash (внутренней памяти) ==

[[Image:menu15.jpg|thumb|Booting from NOR Flash]]

# Для начала прочтите другие секции этой страницы, поскольку у вас будет 30 секунд на то, чтобы ввести команды прошивки, вернитесь сюда, когда будете готовы.
# Не подсоединяйте USB кабель от PC к вашему Neo FreeRunner (отсоедините его).
# Загрузите ваш Neo FreeRunner в NOR uBoot для прошивки.
## Зажмите и удерживайте кнопку AUX
## Нажмите кнопку Power пока не появится меню загрузки
## Это меню помечено '''*** BOOT MENU (NOR) ***'''
## См. также [[Booting the Neo FreeRunner | Загрузка Neo FreeRunner]]
# Оставайтесь в NOR uBoot меню, не выбирайте и не входите ни в какой другой пункт меню. Теперь вы имеете возможность прошивки, резервного копирования вашего FreeRunner или обращения к устройству посредством dfu-util.
# FreeRunner остается в NOR boot около 30 секунд и выключается, если вы ничего не предпримите.
# Подсоедините ваш Neo к GNU/Linux или Windows хосту через USB кабель.
# Теперь вы можете водить команды dfu-util с PC как описано ниже.
# Если Neo FreeRunner выключится перед тем, как вы нажмете начать прошивку ('''экран станет черным'''), вернитесь назад к пункту 2. Если вы начали прошивку вовремя, телефон не отключится сразу.

<!-- The following, upto dfu-util -l is taken from the thread "Re: FreeRunner (GTK2007.2) has suddenly become unbootable" on the Support list. -->

Имейте ввиду, что соединение dfu-util '''не''' использует Ethernet через USB - это значит, что вы не должны настраивать сетевой интерфейс usb0 на вашем GNU/Linux хосте (в Windows вам потребуется DFU class драйвер, или LibUSB-Win32 драйвер, описанный на странице [[Dfu-util-windows]]). dfu-util устанавливает свои собственные соединения с FreeRunner. Фактически, вы не можете установить соединение Ethernet-через-USB с FreeRunner, когда он будет в uBoot меню; этот тип соединения доступен только когда FreeRunner загружен полностью.

После соединения FreeRunner к вашему хосту через USB кабель, вы можете проверить, "видит" ли dfu-util ваш FreeRunner, выполнив:

dfu-util -l

Если вы получите сообщения об ошибках от команды dfu-util тогда попробуйте снова. Часто это работает со второй попытки.

Также, пожалуйста не забудьте выполнять команду dfu-util с достаточными привилегиями (те. root) -- вам потребуется полный контроль над шиной usb.

== Резервное копирование ==

Если у вас есть рабочий образ, который вам нравится, вероятно, вы должны сделать [[Pre-Flash Backup]].

== Использование dfu-util ==

dfu-util может использоваться для чтения флеш памяти, записи памяти, и получения информации от устройства.

Это - основной формат команды для записи файла образа на (предопределенный) "раздел"
(называемый 'altsetting' в руководстве по dfu-util) :

dfu-util -a ''altsetting'' -R -D ''file_name''

где:<br>
-a ''altsetting'' : Указывает altsetting интерфейса DFU по имени или номеру<br>
-R  : Issue USB Reset signalling once we're finished<br>
-D  ''file_name'' : Запись прошивки из ''file_name'' на устройство

В Linux, вы запускаете dfu-util из приглашения командной оболочки. Если dfu-util не является стандартной командой, возможно вам потребуется добавить к ней префикс "./", например так: '''./dfu-util'''.
На некоторых системах вам потребуется стать пользователем root, перед тем, как это будет работать, а на Ubuntu вы должны предварить вызов командой "sudo" иначе вы получите следующую ошибку: "Cannot claim interface: could not claim interface 2: Operation not permitted"

На Windows, вам придется открыть окно ввода команд, чтобы вводить соответствующие команды. Используйте Пуск-Выполнение команды и напечатайте "cmd" для открытия окна.

Более детальное руководство по dfu-util доступно здесь : [[Dfu-util]]

== Прошивка ядра ==

Важно: Телефон должен быть в меню U-boot для того, чтобы работать.
Доберитесь до него, зажав и удерживая кнопку AUX, приводя устройство в действие.

Формат команды следующий:

dfu-util -a kernel -R -D ''/path/to/uImage''

Когда прошивка завершена, будет показано следующее:

status(0) = No error condition is present
Done!

Прошивка может закончится неудачей с ошибкой -110. Это означает, что ядро слишком большое для раздела ядра по умолчанию. uboot может быть применен для изменения размера раздела по умолчанию на устройстве. Это может также означать, что вы пытаетесь разместить что-то неподходящее в области ядра.

== Прошивка основной файловой системы ==

Корневая файловая система должна быть образом в формате jffs2. Если загруженный вами файл упакован или сжат (имеет .gz, bz2, .zip, tar, tar.gz или .tgz расширение) сперва вам следует его распаковать.

Формат команды здесь такой:

dfu-util -a rootfs -R -D ''rootfs_filename.jffs2''

где ''rootfs_filename.jffs2'' это имя файла, содержащего корневую файловую систему.

Когда прошивка завершена, будет показано следующее сообщение:

status(0) = No error condition is present
Done!

== Прошивка загрузчика в NAND==

Файл загрузчика (U-boot) имеет расширение .bin. Как в случае с корневой файлоой системой, если загруженный файл упакован или сжат (имеет расширение .gz или .zip), вам следует сперва его распаковать.

формат команды:

dfu-util -a u-boot -R -D ''uboot.bin''

где ''uboot.bin'' имя двоичного файла загрузчика.

''Напоминание'': Вы должны [[Flashing_the_Neo_FreeRunner#Boot_the_FreeRunner_from_NOR_Flash|сначала загрузить NOR]], чтобы прошить загрузчик в NAND. После завершения прошивки, убедитесь, что загрузка происходит с новым прошитым NAND загрузчиком, чтобы извлечь выгоду из обновлений.

<!-- Taken from posts by Mikael Berthe <mikael.berthe@lilotux.net> and Torfinn Ingolfsen <tingox@gmail.com> to Support list, subject: Re: Upgrading u-boot needed ? -->
(Дополнительно) После обновления вы можете пожелать проверить, что версия u-boot соответствует той, которую вы только что прошили. Вы можете использовать 'grep  Bootloader /dev/mtdblock1' из оболочки FreeRunner (или, возможно, 1973) для получения версии '''NAND''' u-boot, подобно следующему:
root@om-gta02:~# grep Bootloader /dev/mtdblock1
Neo1973 Bootloader U-Boot 1.3.2+gitr18+64eb10cab8055084ae25ea4e73b66dd03cc1a0cb

Вы можете выполнить тоже самое для /dev/mtdblock0, чтобы получить версию '''NOR''' u-boot:
root@om-gta02:~# grep  Bootloader /dev/mtdblock0
Neo1973 Bootloader U-Boot 1.3.2-moko12

<!-- ENDS ... subject: Re: Upgrading u-boot needed ? -->

== Перезагрузка FreeRunner с NAND ==

You should now be able to boot into the new images.

Pay attention '''to booting from the NAND flash this time''', in particular if you upgraded the boot-loader (in short: 1. press and hold ''power button'' down, and then 2. press ''aux button'')

The boot menu should be labelled '''*** BOOT MENU (NAND) ***''' this time (see [[Booting#Log_into_U-Boot_in_the_NAND_Flash|booting from NAND]] for more detailed instructions).

== Скрипт который все это делает GUI... ==

... в разработке, смотри [http://lists.openmoko.org/pipermail/community/2008-September/029731.html this thread] и [http://lists.openmoko.org/pipermail/community/2008-September/030257.html that update]. Скачать http://users.on.net/~antisol/frutil

[[Category:Flashing Openmoko|Flashing Openmoko]]
